# 3.JavaScript性能优化

## JavaScript语言的优化

- 内存管理
- 垃圾回收与常见GC算法
- V8引擎的垃圾回收
- Performance工具
- 代码优化实例

## JavaScript内存管理

内存管理介绍

- 内存：由可读写单元组成，表示一片可操作空间
- 管理：人为的去操作一片空间的申请、使用和释放
- 内存管理：开发者主动申请空间、使用空间、释放空间
- 管理流程：申请一使用一释放

 

JavaScript中的内存管理

- 申请内存空间
- 使用内存空间
- 释放内存空间

## JavaScript中的垃圾

- JavaScript中内存管理是自动的
- 对象不再被引用时是垃圾
- 对象不能从根上访问到时是垃圾

### JavaScript中的可达对象

- 可以访问到的对象就是可达对象（引用、作用域链）
- 可达的标准就是从根出发是否能够被找到
- JavaScript中的根就可以理解为是全局变量对象

# GC算法介绍

## GC定义与作用

GC就是垃圾回收机制的简写

GC可以找到内存中的垃圾、并释放和回收空间

## GC里的垃圾是什么 

- 程序中不再需要使用的对象 

```javascript
function func(){ 
    name='1g' 
    return `${name}is a coder`
}
func() 
```

- 程序中不能再访问到的对象 

```javascript
function func(){ 
    const name = '1g' 
    return `${name}is a coder`
}
func() 
```

## GC算法是什么

- GC是一种机制，垃圾回收器完成具体的工作
- 工作的内容就是查找垃圾释放空间、回收空间
- 算法就是工作时查找和回收所遵循的规则

###  常见GC算法

- 引用计数
- 标记清除
- 标记整理
- 分代回收

### 引用计数算法实现原理

- 核心思想：设置引用数，判断当前引用数是否为0
- 引用计数器
- 引用关系改变时修改引用数值
- 引用数值为0时立即回收

优缺点

优点：

- 发现垃圾时立即回收

- 最大限度减少程序暂停

  内存占满就回收垃圾释放空间

缺点：

- 无法回收循环引用的对象

```javascript
function fn() {
    const obj1 = {}
    const obj2 = {}
    obj1.name = obj2
    obj2.name = obj1
    return 'anything'
}
fn()
```

- 时间开销大

  数值修改需要时间

### 标记清除算法实现原理

- 核心思想：分标记和清除两个阶段
- 遍历所有对象并标记活动对象
- 遍历所有对象并清除没有标记的对象，并且清除掉那些有标记但不活动的对象的标记
- 回收相应的空间

优缺点

优点：

​	✔相对于引用计数算法来说，可以回收那些循环引用的对象

缺点：

​	❌垃圾回收产生空间碎片化的问题（回收的空间不连续），无法最大化利用空间

### 标记整理算法实现原理

- 标记整理可以看作是标记清除的增强
- 标记阶段的操作和标记清除一致
- 清除阶段会先执行整理，移动位置，再清理（最大化利用空间）

整理过程图解



## 常见GC算法总结

1. 引用计数

   ✔可以及时回收垃圾对象

   ✔减少程序卡顿时间

   ❌无法回收循环引用对象

   ❌资源消耗大

2. 标记清除

   ✔可以回收循环引用的对象

   ❌容易产生碎片化空间，造成浪费

   ❌不会立即回收垃圾对象

3. 标记整理

   ✔减少碎片化空间

   ❌不会立即回收垃圾对象

# 认识V8

- V8是一款主流的JavaScript引擎
- V8采用即时编译(速度快)
- V8设有内存上限

32位不超过800M

64位不超过1.5G

 

## V8垃圾回收策略

原始数据是由程序语言本身来控制

V8主要是对对象数据的回收

 

- 采用分代回收的思想
- 内存分为新生代、老生代
- 针对不同对象采用不同算法

策略图解

## V8中常用GC算法

- 分代回收
- 空间复制
- 标记清除
- 标记整理
- 标记增强

## V8如何回收新生代对象

### V8内存分配

- V8内存一分为二
- 小空间用于存储新生代对象（32M | 16M）
- 新生代指存活时间较短的对象（如函数作用域中的对象）

### 新生代对象回收实现

- 回收过程采用复制算法+标记整理
- 新生代内存区分为二个等大小空间
- 使用空间为From，空闲空间为To
- 活动对象存储于From空间
- 标记整理后将活动对象拷贝至To（先清除了不活动的对象，再拷贝）
- From与To交换空间完成释放

### ❓为什么要做交换空间的过程?

回收细节说明

- 拷贝过程中可能出现晋升
- 晋升就是将新生代对象移动至老生代
- 一轮GC还存活的新生代需要晋升
- To空间的使用率超过25%

**主要就是会有一些新生代对象转换为老生代**

## V8如何回收老生代对象

### 老年代对象说明

- 老年代对象存放在右侧老生代区域
- 64位操作系统1.4G，32操作系统700M（大小）
- 老年代对象就是指存活时间较长的对象（全局对象，闭包等）

 

### 老生代对象回收实现

- ⭐主要采用标记清除、标记整理、增量标记算法
- 首先使用标记清除完成垃圾空间的回收
- 采用标记整理进行空间优化
- 采用增量标记进行效率优化